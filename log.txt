
-- /home/ahmad/repo/northwindDWH/northwind/models/marts/dimensions/dim_category.sql

{{
    config(
        materialized='incremental',
        strategy='append',
        unique_key='category_sk',
        indexes = 
        [
            {"columns": ['category_sk'], 'unique': True},
        ]
    ) 
}}



WITH category AS (
    SELECT 
        category_sk
        , category_name
        , description
    FROM 
        {{ ref('stg_categories') }}
)
SELECT * FROM category
-----------------------------------------------------------


-- /home/ahmad/repo/northwindDWH/northwind/models/marts/dimensions/dim_location.sql

{{
    config(
        materialized='incremental',
        strategy='append',
        unique_key='location_sk',
        indexes = 
        [
            {"columns": ['location_sk'], 'unique': True},
        ]
    ) 
}}

WITH suppliers_location AS (
    SELECT DISTINCT
        address
        ,city
        ,region
        ,postal_code
        ,country
    FROM
        {{ ref('stg_suppliers') }}
)
,
orders_location AS (
    SELECT DISTINCT
        ship_address        AS address
        ,ship_city           AS city
        ,ship_region         AS region
        ,ship_postal_code    AS postal_code
        ,ship_country        AS country
    FROM
        {{ ref('stg_orders') }}
)
,
pre_location_dim AS (
    SELECT
        *
    FROM 
        suppliers_location
    
    UNION
    
    SELECT
        *
    FROM
        orders_location
)
,
location_dim AS (
    SELECT
        MD5(address || postal_code) AS location_sk
        , *
    FROM 
        pre_location_dim
)
SELECT * FROM location_dim
-----------------------------------------------------------


-- /home/ahmad/repo/northwindDWH/northwind/models/marts/dimensions/dim_products.sql

{{
    config(
        materialized='incremental',
        strategy='merge',
        unique_key='dbt_scd_id',
        indexes = 
        [
            {"columns": ['dbt_scd_id'], 'unique': True},
            {"columns": ['category_sk'], 'unique': False},
        ]
    )
}}


WITH scd2_products AS (
    SELECT  
        product_SK
        , product_name
        , category_id
        , unit_price
        , quantity_per_unit
        , discontinued
        , dbt_scd_id
        , dbt_updated_at
        , dbt_valid_from
        , dbt_valid_to
        , data_src
    FROM
        {{ ref('stg_products') }}
)
,
eniched AS (
    SELECT
        p.product_SK
        , p.product_name
        , c.category_sk
        , p.unit_price
        , p.quantity_per_unit
        , p.discontinued
        , p.dbt_scd_id
        , p.dbt_updated_at
        , p.dbt_valid_from
        , p.dbt_valid_to
    FROM
        scd2_products p
    LEFT JOIN
        {{ ref('stg_categories') }} c  
    ON
        c.category_id = p.category_id
    AND
        c.data_src = p.data_src
)
SELECT * FROM eniched
-----------------------------------------------------------


-- /home/ahmad/repo/northwindDWH/northwind/models/marts/dimensions/dim_suppliers.sql

{{
    config(
        materialized='incremental',
        strategy='merge',
        unique_key='supplier_sk',
        indexes = 
        [
            {"columns": ['supplier_sk'], 'unique': True},
        ]
    ) 
}}

WITH suppliers AS (
    SELECT
        DISTINCT
        supplier_sk
        , company_name
        , contact_name
        , contact_title
        , MD5(address || postal_code) AS location_sk
        , phone
        , fax
        , homepage
    FROM 
        {{ ref('stg_suppliers') }}
)
SELECT * FROM suppliers
-----------------------------------------------------------


-- /home/ahmad/repo/northwindDWH/northwind/models/marts/inventory/fact_inventory.sql

{{
    config(
        materialized='incremental',
        strategy='append',
        unique_key='dbt_scd_id',
        indexes = 
        [
            {"columns": ['dbt_scd_id'], 'unique': True},
            {"columns": ['supplier_sk'], 'unique': False},
        ]
    ) 
}}

WITH inventory AS (
    SELECT
        product_SK
        , supplier_id
        , quantity_per_unit
        , units_in_stock
        , units_on_order
        , reorder_level
        , dbt_scd_id
        , dbt_updated_at
        , data_src
    FROM
        {{ ref('stg_inventory') }}
)
,
enriched AS (
    SELECT
        i.product_SK
        , s.supplier_sk
        , i.quantity_per_unit
        , i.units_in_stock
        , i.units_on_order
        , i.reorder_level
        , i.dbt_scd_id as record_id
        , i.dbt_updated_at as updated_at
    FROM
        inventory i
    LEFT JOIN
        {{ ref('stg_suppliers') }} s  
    ON
        s.supplier_id = i.supplier_id
    AND
        c.data_src = i.data_src
)
SELECT * FROM enriched
-----------------------------------------------------------


-- /home/ahmad/repo/northwindDWH/northwind/models/marts/orders/fact_orders.sql

{{
    config(
        materialized='incremental',
        strategy='merge',
        unique_key='transaction_id',
        indexes = 
        [
            {"columns": ['transaction_id'], 'unique': True},
            {"columns": ['location_sk'], 'unique': False},
            {"columns": ['product_sk'], 'unique': False},
        ]
    ) 
}}


WITH orders AS (
    SELECT
         order_id
        , data_src
        , order_date
        , required_date
        , shipped_date
        , MD5(ship_address || ship_postal_code) AS location_sk
    FROM
        {{ ref('stg_orders') }}
    WHERE
        shipped_date IS NOT NULL
)
,
order_details AS (
    SELECT
        p.product_SK
        , o.order_id
        , o.unit_price
        , o.quantity
        , o.discount
        , o.data_src
    FROM 
        {{ ref('stg_order_details') }} o
    LEFT JOIN
        {{ ref('stg_products') }} p
    ON 
        o.product_id=p.product_id
    AND
        o.data_src=p.data_src
)
,
fact_table AS (
    SELECT
        MD5(o.order_id||od.product_sk||o.data_src) AS transaction_id
        ,o.order_id
        ,o.data_src
        ,o.order_date
        ,o.required_date
        ,o.shipped_date
        ,o.location_sk
        ,od.product_sk
        ,od.unit_price
        ,od.quantity
        ,od.discount
    FROM
        orders o
    LEFT JOIN
        order_details od 
    ON
        o.order_id=od.order_id
    AND
        o.data_src=od.data_src
)
SELECT
    *
FROM
    fact_table
-----------------------------------------------------------

